---
title: "Stochastic Mode: Policy Analysis"
subtitle: "Uncertainty quantification and mode convergence"
engine: julia
execute:
  exeflags: ["--project=.."]
---

## Overview

This guide shows how to analyze policies with stochastic simulation, quantify uncertainty, and verify convergence with EAD mode.

## Setup

```{julia}
#| output: false
using ICOW
using Distributions
using Random
using Statistics
using DataFrames
using CairoMakie
```

```{julia}
# Setup
rng = Random.MersenneTwister(42)
city = CityParameters()

# Create matching forcings for both modes
num_scenarios = 200
num_years = 50
surge_dist = GeneralizedExtremeValue(1.0, 0.5, 0.1)

# Stochastic forcing
surges = rand(rng, surge_dist, num_scenarios, num_years)
stoch_forcing = StochasticForcing(surges)

# EAD forcing (same distribution)
ead_forcing = DistributionalForcing([surge_dist for _ in 1:num_years])
```

## Policy Comparison

Let's compare dike heights using both modes:

```{julia}
dike_heights = 0:2:10

results = map(dike_heights) do D
    policy = StaticPolicy(Levers(0.0, 0.0, 0.0, Float64(D), 0.0))

    # EAD mode (single value)
    ead_inv, ead_dmg = simulate(city, policy, ead_forcing)

    # Stochastic mode (multiple scenarios)
    stoch_results = map(1:num_scenarios) do s
        inv, dmg = simulate(city, policy, stoch_forcing; scenario=s, rng=rng)
        (investment=inv, damage=dmg)
    end
    damages = [r.damage for r in stoch_results]

    (
        D = D,
        ead_damage = ead_dmg/1e9,
        stoch_mean = mean(damages)/1e9,
        stoch_std = std(damages)/1e9,
        stoch_p5 = quantile(damages, 0.05)/1e9,
        stoch_p95 = quantile(damages, 0.95)/1e9
    )
end

df = DataFrame(results)
df
```

## Mode Convergence

EAD mode should equal the mean of stochastic mode (Law of Large Numbers):

```{julia}
println("Mode Convergence Check:")
for row in eachrow(df)
    diff_pct = abs(row.ead_damage - row.stoch_mean) / row.ead_damage * 100
    println("  D=$(row.D)m: EAD=$(round(row.ead_damage, digits=1))B, " *
            "Stoch mean=$(round(row.stoch_mean, digits=1))B, " *
            "Diff=$(round(diff_pct, digits=1))%")
end
```

## Visualizing Uncertainty

```{julia}
#| label: fig-uncertainty
#| fig-cap: "Expected damage with uncertainty bands (stochastic mode)"
#| code-fold: true
let
    fig = Figure(size=(700, 500))
    ax = Axis(fig[1, 1];
        xlabel="Dike Height (m)",
        ylabel="Expected Damage (\$ billions)",
        title="EAD vs Stochastic Mode"
    )

    # 90% confidence band
    band!(ax, collect(dike_heights), df.stoch_p5, df.stoch_p95;
        color=(:coral, 0.3), label="90% CI (Stochastic)")

    # Stochastic mean
    scatterlines!(ax, collect(dike_heights), df.stoch_mean;
        marker=:circle, markersize=10, linewidth=2,
        color=:coral, label="Stochastic Mean")

    # EAD
    scatterlines!(ax, collect(dike_heights), df.ead_damage;
        marker=:diamond, markersize=10, linewidth=2,
        color=:steelblue, linestyle=:dash, label="EAD Mode")

    axislegend(ax; position=:rt)
    fig
end
```

## Key Observations

1. **EAD â‰ˆ Stochastic Mean**: Both modes converge to the same expected value (differences are Monte Carlo noise)

2. **Uncertainty Decreases with Protection**: Higher dikes reduce both mean damage and variability

3. **Tail Risk**: The 90% confidence interval shows scenarios with extreme damages (dike failures, unlucky surge sequences)

## When to Use Each Mode

| Use Case | Recommended Mode |
|----------|------------------|
| Fast policy screening | EAD |
| Optimization | EAD |
| Uncertainty quantification | Stochastic |
| Risk analysis (VaR, CVaR) | Stochastic |
| Stress testing | Stochastic |

## Analyzing Tail Risk

Stochastic mode lets us examine worst-case scenarios:

```{julia}
# For D=5m dike, find the worst scenario
policy = StaticPolicy(Levers(0.0, 0.0, 0.0, 5.0, 0.0))

scenario_damages = map(1:num_scenarios) do s
    _, dmg = simulate(city, policy, stoch_forcing; scenario=s, rng=rng)
    (scenario=s, damage=dmg/1e9)
end

# Sort by damage
sorted = sort(scenario_damages, by=x->x.damage, rev=true)

println("Top 5 worst scenarios (D=5m):")
for (i, s) in enumerate(sorted[1:5])
    println("  #$i: Scenario $(s.scenario), Damage=\$$(round(s.damage, digits=1))B")
end
```

## Next Steps

- [Stochastic Optimization](stochastic_optimization.qmd) - Robust policy optimization
- [EAD Analysis](ead_analysis.qmd) - Faster analysis for policy screening
